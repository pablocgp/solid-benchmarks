#!/bin/bash

# Source tutorial run functions
. $WM_PROJECT_DIR/bin/tools/RunFunctions

# Source solids4Foam scripts
source solids4FoamScripts.sh

# Load user variables
echo "Sourcing the USER_VARIABLE_NAMES file"
source USER_VARIABLE_NAMES

if [[ -d "${CASE_NAME}.${MESH}.RC${RHIECHOWFACTORS[0]}.${MACHINE}.${SETTINGS}" ]]
then
    echo "Case ${CASE_NAME}.${MESH}.RC${RHIECHOWFACTORS[0]}.${MACHINE}.${SETTINGS}
     already exists: please remove it"; echo
    exit 1;
fi
 
# Loop over RC scaling factor list and perform simulation
for i in "${RHIECHOWFACTORS[@]}";
do
    CASE="${CASE_NAME}.${MESH}.RC${i}.${MACHINE}.${SETTINGS}"
    echo "Running ${CASE}"

    # Copy template case
    cp -r "${BASE}" "${CASE}"
    
    # Enter the case
    cd "${CASE}"
    
    # Make mesh
    if [ "$USE_GMSH" -eq 1 ]
    then
        # Replace the meshSpacing file
        if [[ ! -f "meshes/meshSpacing$MESH.geo" ]]
        then
            echo "Cannot find ${CASE}/meshes/meshSpacing$MESH.geo: please add it to ${BASE}/meshes/"; echo
            exit 1;
        else
            echo "Copying ${CASE}/meshes/meshSpacing$MESH.geo to ${CASE}/meshes/meshSpacing.geo"
            \cp "meshes/meshSpacing$MESH.geo" meshes/meshSpacing.geo
        fi

        # Create the mesh
        if command -v gmsh &> /dev/null
        then
            # Remporarily rename 0 to avoid issues
            mv 0 0.tmp

            # Create mesh with gmsh
            solids4Foam::runApplication gmsh -3 -format msh2 meshes/cube.geo
            solids4Foam::runApplication gmshToFoam meshes/cube.msh
            solids4Foam::runApplication createPatch -overwrite
            if [ "$USE_POLYDUALMESH" -eq 1 ]
            then
                solids4Foam::runApplication polyDualMesh 30 -overwrite
                solids4Foam::runApplication combinePatchFaces 45 -overwrite
            fi

            # Move 0 back
            mv 0.tmp 0
        else
            echo; echo "Gmsh is required to run this case: please install it"
            exit 1
        fi
    else
        # Replace the blockMeshDict
        if [[ ! -f "system/blockMeshDict.$MESH" ]]
        then
            echo "Cannot find ${CASE}/system/blockMeshDict.$MESH: please add it to ${BASE}/meshes/"; echo
            exit 1;
        else
            echo "Copying ${CASE}/system/blockMeshDict.$MESH to ${CASE}/system/blockMeshDict"
            \cp "system/blockMeshDict.$MESH" system/blockMeshDict
        fi

        # Create the mesh
        solids4Foam::runApplication blockMesh
    fi
    
    # Update Rhie-Chow scaling factor in solidProperties dict
    if grep -q "scaleFactor" constant/solidProperties;
    then
        sed -i "s/scaleFactor.*/scaleFactor  ${i};/" constant/solidProperties
    else
        echo "Cannot find stabilisation subdict in ${CASE}/constant/solidProperties. Please add it."; echo
        exit 1;
    fi
    
    # Run the solver
    # If "gtime" is available (/usr/bin/time on Linux), use it to
    # record the max memory usage. On linux gtime is set to be alias for /usr/bin/time
    if [ -f /usr/bin/time ] || command -v gtime &> /dev/null
    then
        echo "Running solids4Foam on ${CASE} and recording the memory usage"
        if [ -x /opt/homebrew/bin/gtime ]; then
            gtime -f "Maximum resident set size (kbytes): %M" mpirun -np 1 solids4Foam &> log.solids4Foam
        else
            /usr/bin/time -f "Maximum resident set size (kbytes): %M" mpirun -np 1 solids4Foam &> log.solids4Foam
        fi
    else
        echo "Running solids4Foam on ${CASE}"
        #solids4Foam::runApplication solids4Foam
        # Strange PETSc issue on Macbook where I need to use mpirun for serial
        mpirun -np 1 solids4Foam &> log.solids4Foam
    fi

    # Navigate back to the parent directory
    cd ..    

done 

echo; echo "Done"; echo

echo "Run ./AllpostScalingStudy to extract the results"; echo

